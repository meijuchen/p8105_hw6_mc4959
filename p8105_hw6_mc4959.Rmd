---
title: "P8105_HW6_mc4959"
author: "Meiju Chen"
date: "12/9/2020"
output: github_document
---


```{r setup, include = FALSE}
library(tidyverse)
library(dplyr)
library(readxl)
library(ggplot2)
library(p8105.datasets)
library(modelr)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

### Problem 1

##### Read and tidy the data.

```{r read probblem 1 data}

homicide_df = 
  read_csv('./data/homicide_data.csv', na = c('', 'NA', 'Unknown')) %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    result = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c('White', 'Black'),
    city_state != 'Tulsa, AL'
  ) %>% 
  select(city_state, result, victim_age, victim_race, victim_sex)

```

##### Baltimore, MD

Start with one city - Baltimore, MD.

```{r Baltimore}

baltimore_df = 
  homicide_df %>% 
  filter(city_state == 'Baltimore, MD')
glm(result ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()
  ) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)

```


##### Model for each cities

Try this across cities in the dataset.

```{r cities in the dataset}

model_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(result ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    report = map(models, broom::tidy)
    ) %>%
  select(city_state, report) %>% 
  unnest(report) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI"))

```


##### Plot

Create a plot that shows the estimated ORs and CIs for each city.

```{r plot}

model_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

***

### Problem 2

##### Load and clean the data.

```{r read problem 2 data}

bw_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = case_when(
      babysex == 1 ~ "Male",
      babysex == 2 ~ "Female"
    ),
    frace = case_when(
      frace == 1 ~ "White",
      frace == 2 ~ "Black",
      frace == 3 ~ "Asian",
      frace == 4 ~ "Puerto Rican",
      frace == 8 ~ "Other",
      frace == 9 ~ "Unknown"
    ),
    mrace = case_when(
      mrace == 1 ~ "White",
      mrace == 2 ~ "Black",
      mrace == 3 ~ "Asian",
      mrace == 4 ~ "Puerto Rican",
      mrace == 8 ~ "Other"
    ),
    malform = case_when(
      malform == 0 ~ "absent",
      malform == 1 ~ "present"
    ),
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    mrace = as.factor(mrace),
    malform = as.factor(malform)
  ) %>% 
  drop_na()

```
The dataset contains `r nrow(bw_df)` rows and `r ncol(bw_df)` columns, and there is no missing data.

<br>

##### Regression Model

I use stepwise elimination to find good predictors by the p-value for the following regression model. The model looks like this: `lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = baby_df)`.

```{r regression model}

# stepwise elimination
stepwise_model = 
  lm(bwt ~ ., data = bw_df) %>% 
  step(., direction = "both") %>% 
  broom::tidy()

# regression model
r_model = 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = bw_df)

r_model %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)

```

<br>

##### Residual Plot

```{r residual plot}

bw_df %>% 
  add_residuals(r_model) %>% 
  add_predictions(r_model) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(color = '#85C1E9', alpha = 0.4) +
  labs(
    title = 'Residual vs. fitted values for the stepwise eliminated model',
    x = 'Predictions',
    y = 'Residuals'
  )

```

<br>

##### Two other models

```{r two other models}

model_1 = lm(bwt ~ blength + gaweeks, data = bw_df)
model_2 = lm(bwt ~ bhead * blength * babysex, data = bw_df)

model_1 %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)

model_2 %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)

```

